

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>pyschedcl.pyschedcl &mdash; PySchedCL 1.0 documentation</title>

    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />


      <link rel="top" title="PySchedCL 1.0 documentation" href="../../home.html" />

      <link rel="author" title="About these documents" href="#" />
      <link rel="index" title="Index" href="../../genindex.html" />
      <link rel="search" title="Search" href="../../search.html" />
      <link rel="top" title="PySchedCL documentation" href="../../home.html" />


  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">


    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">



            <a href="../../home.html" class="icon icon-home"> PySchedCL



          </a>




              <div class="version">
                1.0
              </div>




<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <ul>
            <li class="toctree-l1"><a class="reference internal" href="../../home.html">Home</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../pyschedcl.html">API Documentation</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../json_tutorial.html">Kernel Specification File</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../partitioning.html">Partitioning</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../scheduling.html">Scheduling</a></li>
            <li class="toctree-l1"><a class="reference internal" href="../../commands.html">Commands</a></li>
            <!-- <li class="toctree-l1"><a class="reference internal" href="releasenotes.html">Release notes</a></li> -->
            <li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../home.html">PySchedCL</a>
      </nav>



      <div class="wy-nav-content">
        <div class="rst-content">






          <div role="navigation" aria-label="breadcrumbs navigation">
            <ul class="wy-breadcrumbs">
              <li><a href="#">Docs</a> &raquo;</li>

              <li>PySchedCL&#8217;s documentation!</li>
              <li class="wy-breadcrumbs-aside">

                <div class=asetop>
                  <a href=../../genindex.html>index</a> | <a href=../../pyschedcl.html>modules</a> | <a href="https://github.com/anighose25/pyschedcl">github</a> | <a href=#>source</a>
                </div>
              </li>
            </ul>
            <hr/>
          </div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for pyschedcl.pyschedcl</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">pyopencl</span> <span class="kn">as</span> <span class="nn">cl</span>
<span class="kn">import</span> <span class="nn">pyopencl.tools</span>
<span class="kn">import</span> <span class="nn">pyopencl.array</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">mutex</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">constant_pyschedcl</span> <span class="kn">as</span> <span class="nn">cons</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">numpy_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;unsigned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
    <span class="s2">&quot;unsigned int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
    <span class="s2">&quot;uint&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
    <span class="s2">&quot;long int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;double&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="s2">&quot;char&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
    <span class="s2">&quot;short&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
    <span class="s2">&quot;uchar&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="s2">&quot;unsigned char&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="s2">&quot;ulong&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
    <span class="s2">&quot;unsigned long&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
    <span class="s2">&quot;ushort&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
    <span class="s2">&quot;unsigned short&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>
<span class="p">}</span>

<span class="n">VEC_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;char16&#39;</span><span class="p">,</span> <span class="s1">&#39;char2&#39;</span><span class="p">,</span> <span class="s1">&#39;char3&#39;</span><span class="p">,</span> <span class="s1">&#39;char4&#39;</span><span class="p">,</span> <span class="s1">&#39;char8&#39;</span><span class="p">,</span> <span class="s1">&#39;double16&#39;</span><span class="p">,</span> <span class="s1">&#39;double2&#39;</span><span class="p">,</span> <span class="s1">&#39;double3&#39;</span><span class="p">,</span> <span class="s1">&#39;double4&#39;</span><span class="p">,</span> <span class="s1">&#39;double8&#39;</span><span class="p">,</span>
             <span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="s1">&#39;float2&#39;</span><span class="p">,</span> <span class="s1">&#39;float3&#39;</span><span class="p">,</span> <span class="s1">&#39;float4&#39;</span><span class="p">,</span> <span class="s1">&#39;float8&#39;</span><span class="p">,</span> <span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="s1">&#39;int2&#39;</span><span class="p">,</span> <span class="s1">&#39;int3&#39;</span><span class="p">,</span> <span class="s1">&#39;int4&#39;</span><span class="p">,</span> <span class="s1">&#39;int8&#39;</span><span class="p">,</span> <span class="s1">&#39;long16&#39;</span><span class="p">,</span>
             <span class="s1">&#39;long2&#39;</span><span class="p">,</span> <span class="s1">&#39;long3&#39;</span><span class="p">,</span> <span class="s1">&#39;long4&#39;</span><span class="p">,</span> <span class="s1">&#39;long8&#39;</span><span class="p">,</span> <span class="s1">&#39;short16&#39;</span><span class="p">,</span> <span class="s1">&#39;short2&#39;</span><span class="p">,</span> <span class="s1">&#39;short3&#39;</span><span class="p">,</span> <span class="s1">&#39;short4&#39;</span><span class="p">,</span> <span class="s1">&#39;short8&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar16&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar2&#39;</span><span class="p">,</span>
             <span class="s1">&#39;uchar3&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar4&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar8&#39;</span><span class="p">,</span> <span class="s1">&#39;uint16&#39;</span><span class="p">,</span> <span class="s1">&#39;uint2&#39;</span><span class="p">,</span> <span class="s1">&#39;uint3&#39;</span><span class="p">,</span> <span class="s1">&#39;uint4&#39;</span><span class="p">,</span> <span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong16&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong2&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong3&#39;</span><span class="p">,</span>
             <span class="s1">&#39;ulong4&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong8&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort16&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort2&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort3&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort4&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort8&#39;</span><span class="p">,</span> <span class="p">]</span>



<span class="n">SOURCE_DIR</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">SOURCE_DIR</span>
<span class="n">MAX_GPU_ALLOC_SIZE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MAX_CPU_ALLOC_SIZE</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">VEC_TYPES</span><span class="p">:</span>
    <span class="n">numpy_types</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;cl.array.vec.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datatype</span><span class="p">))</span>

<span class="n">system_cpus</span><span class="p">,</span> <span class="n">system_gpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">nGPU</span><span class="p">,</span> <span class="n">nCPU</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">device_history</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">ready_queue</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(),</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()}</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">mutex</span><span class="o">.</span><span class="n">mutex</span><span class="p">()</span>
<span class="n">user_defined</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">dump_output</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">bolt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rqlock</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">callback_queue</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="compare_and_swap"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.compare_and_swap">[docs]</a><span class="k">def</span> <span class="nf">compare_and_swap</span><span class="p">(</span><span class="n">testval</span><span class="p">,</span> <span class="n">newval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Software test and lock routine used for enforcing mutual exclusion across multiple callback threads.</span>

<span class="sd">    :param testval: List representing testing lock value</span>
<span class="sd">    :type testval: list</span>
<span class="sd">    :param newval: List representing new lock value</span>
<span class="sd">    :type newval: list</span>
<span class="sd">    :return: Returns list representing old lock value.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">bolt</span>
    <span class="n">oldval</span> <span class="o">=</span> <span class="n">bolt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">oldval</span> <span class="o">==</span> <span class="n">testval</span><span class="p">:</span>
        <span class="n">bolt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
    <span class="k">return</span> <span class="n">oldval</span></div>


<div class="viewcode-block" id="test_and_set"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.test_and_set">[docs]</a><span class="k">def</span> <span class="nf">test_and_set</span><span class="p">(</span><span class="n">testval</span><span class="p">,</span> <span class="n">newval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Software test and lock routine used for enforcing mutual exclusion across callback threads and main host thread while accessing ready queue and device counters.</span>

<span class="sd">    :param testval: List representing testing lock value</span>
<span class="sd">    :type testval: list</span>
<span class="sd">    :param newval: List representing new lock value</span>
<span class="sd">    :type newval: list</span>
<span class="sd">    :return: Returns list representing old lock value.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">rqlock</span>
    <span class="n">oldval</span> <span class="o">=</span> <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">oldval</span> <span class="o">==</span> <span class="n">testval</span><span class="p">:</span>
        <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
    <span class="k">return</span> <span class="n">oldval</span></div>


<div class="viewcode-block" id="blank_fn"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.blank_fn">[docs]</a><span class="k">def</span> <span class="nf">blank_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does nothing. Used as dummy function for callback events.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="HostEvents"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.HostEvents">[docs]</a><span class="k">class</span> <span class="nc">HostEvents</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for storing timing information of various events associated with a kernel.</span>

<span class="sd">    :ivar dispatch_start: Start Timestamp for dispatch function</span>
<span class="sd">    :ivar dispatch_end:  End Timestamp for dispatch function</span>
<span class="sd">    :ivar create_buf_start: Start Timestamp for Creation of Buffers</span>
<span class="sd">    :ivar create_buf_end: End Timestamp for Creation of Buggers</span>
<span class="sd">    :ivar write_start: Start TimeStamp for Enqueuing Write Buffer Commands on Command Queue</span>
<span class="sd">    :ivar write_end: End Timestamp for Writing of Buffers to Device</span>
<span class="sd">    :ivar ndrange_start: Start TimeStamp for Launching Kernel</span>
<span class="sd">    :ivar ndrange_end: End Timestamp for when kernel execution is finished on device</span>
<span class="sd">    :ivar read_start:  Start TimeStamp for Enqueuing Read Buffer Commands on Command Queue</span>
<span class="sd">    :ivar read_end: End TimeStamp for Reading of Buffers from Device to Host</span>
<span class="sd">    :ivar kernel_name: Name of kernel</span>
<span class="sd">    :ivar kernel_id: Unique id for kernel</span>
<span class="sd">    :ivar dispatch_id: Dispatch id for kernel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">kernel_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dispatch_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dispatch_end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">create_buf_start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create_buf_end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ndrange_start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ndrange_end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">read_start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">read_end</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise attributes of HostEvents class .</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_start</span> <span class="o">=</span> <span class="n">dispatch_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_end</span> <span class="o">=</span> <span class="n">dispatch_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_buf_start</span> <span class="o">=</span> <span class="n">create_buf_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_buf_end</span> <span class="o">=</span> <span class="n">create_buf_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_start</span> <span class="o">=</span> <span class="n">write_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_end</span> <span class="o">=</span> <span class="n">write_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndrange_start</span> <span class="o">=</span> <span class="n">ndrange_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndrange_end</span> <span class="o">=</span> <span class="n">ndrange_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_start</span> <span class="o">=</span> <span class="n">read_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_end</span> <span class="o">=</span> <span class="n">read_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_name</span> <span class="o">=</span> <span class="n">kernel_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_id</span> <span class="o">=</span> <span class="n">kernel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_id</span> <span class="o">=</span> <span class="n">dispatch_id</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="dump_device_history"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.dump_device_history">[docs]</a><span class="k">def</span> <span class="nf">dump_device_history</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps device history to debug.log file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">debug_strs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">min_timestamp</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;Infinity&#39;</span><span class="p">)</span>
    <span class="n">max_timestamp</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">device_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">device_history</span><span class="p">[</span><span class="n">dev</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">host_event</span> <span class="ow">in</span> <span class="n">device_history</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">device_id</span><span class="p">]:</span>
                <span class="n">kernel_id</span> <span class="o">=</span> <span class="n">host_event</span><span class="o">.</span><span class="n">kernel_id</span>
                <span class="n">kernel_name</span> <span class="o">=</span> <span class="n">host_event</span><span class="o">.</span><span class="n">kernel_name</span>
                <span class="n">write_start</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.20f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">host_event</span><span class="o">.</span><span class="n">write_start</span>
                <span class="n">min_timestamp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_timestamp</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">write_start</span><span class="p">))</span>
                <span class="n">write_end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.20f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">host_event</span><span class="o">.</span><span class="n">write_end</span>
                <span class="n">ndrange_start</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.20f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">host_event</span><span class="o">.</span><span class="n">ndrange_start</span>
                <span class="n">ndrange_end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.20f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">host_event</span><span class="o">.</span><span class="n">ndrange_end</span>
                <span class="n">read_start</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.20f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">host_event</span><span class="o">.</span><span class="n">read_start</span>
                <span class="n">read_end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.20f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">host_event</span><span class="o">.</span><span class="n">read_end</span>
                <span class="n">max_timestamp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_timestamp</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">read_end</span><span class="p">))</span>
                <span class="n">debug_str</span> <span class="o">=</span> <span class="s2">&quot;HOST_EVENT &quot;</span> <span class="o">+</span> <span class="n">dev</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">kernel_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">kernel_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">write_start</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">write_end</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> \
                            <span class="n">ndrange_start</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">ndrange_end</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">read_start</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">read_end</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">debug_str</span><span class="p">)</span>
                <span class="c1"># print debug_str</span>
                <span class="n">debug_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">debug_str</span><span class="p">)</span>
    <span class="n">profile_time</span> <span class="o">=</span> <span class="n">max_timestamp</span> <span class="o">-</span> <span class="n">min_timestamp</span>
    <span class="k">print</span> <span class="s2">&quot;span_time &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">profile_time</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">debug_strs</span></div>


<div class="viewcode-block" id="partition_round"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.partition_round">[docs]</a><span class="k">def</span> <span class="nf">partition_round</span><span class="p">(</span><span class="n">elms</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">exact</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partitions dataset in a predictable way.</span>

<span class="sd">    :param elms: Total Number of elements</span>
<span class="sd">    :type elms: Integer</span>
<span class="sd">    :param percent: Percentage of problem space to be processed on one device</span>
<span class="sd">    :param type: Integer</span>
<span class="sd">    :param exact: Flag that states whether percentage of problem space is greater than 50 or not (0 for percent &lt; 50, 1 for percent &gt;= 50)</span>
<span class="sd">    :param type: Integer</span>
<span class="sd">    :param total: Percentage of total problem space (Default value: 100)</span>
<span class="sd">    :type total: Integer</span>
<span class="sd">    :return: Number of elements of partitioned dataset</span>
<span class="sd">    :rtype: Integer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">elms</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">elms</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">elms</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">exact</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">percent</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">elms</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">percent</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;PARTITION: get_slice_values -&gt; multiple_round -&gt; partition_round (if percent=50) returns: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">elms</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">elms</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="n">percent</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span>
            <span class="k">return</span> <span class="n">partition_round</span><span class="p">(</span><span class="n">elms</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span> <span class="k">if</span> <span class="n">total</span> <span class="o">!=</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">elms</span> <span class="o">-</span> <span class="n">b</span>
        <span class="k">elif</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION: get_slice_values -&gt; multiple_round -&gt; partition_round (if exact=1) returns: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">x</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="n">factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">percent</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">partition_round</span><span class="p">(</span><span class="n">elms</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">partition_round</span><span class="p">(</span><span class="n">elms</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></div>


<span class="n">part_round</span> <span class="o">=</span> <span class="n">partition_round</span>


<div class="viewcode-block" id="multiple_round"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.multiple_round">[docs]</a><span class="k">def</span> <span class="nf">multiple_round</span><span class="p">(</span><span class="n">elms</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">multiples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partitions such that the partitioned datasets are multiples of given number.</span>

<span class="sd">    :param elms: Total number of elements of buffer</span>
<span class="sd">    :type elms: Integer</span>
<span class="sd">    :param percent: Percentage of problem space to be processed by one device</span>
<span class="sd">    :type percent: Integer</span>
<span class="sd">    :param multiples: List of integers representing partition multiples for each dimension</span>
<span class="sd">    :type multiples: list of integers</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return: Percentage of buffer space to be partitioned for one device</span>
<span class="sd">    :rtype: Integer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">multiple</span> <span class="ow">in</span> <span class="n">multiples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elms</span> <span class="o">%</span> <span class="n">multiple</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">elms</span> <span class="o">&gt;</span> <span class="n">multiple</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">elms</span> <span class="o">/</span> <span class="n">multiple</span>
            <span class="k">return</span> <span class="n">partition_round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiple</span></div>


<div class="viewcode-block" id="ctype"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.ctype">[docs]</a><span class="k">def</span> <span class="nf">ctype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string datatype to corresponding Numpy datatype. User can also define new datatypes using user_defined parameter.</span>

<span class="sd">    :param dtype: Datatype name</span>
<span class="sd">    :type dtype: String</span>
<span class="sd">    :return: Numpy Datatype corresponding to dtype</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">numpy_types</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Data Type {} not defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span></div>


<div class="viewcode-block" id="make_ctype"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.make_ctype">[docs]</a><span class="k">def</span> <span class="nf">make_ctype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a vector datatype.</span>

<span class="sd">    :param dtype: Datatype name</span>
<span class="sd">    :type dtype: String</span>
<span class="sd">    :return: numpy datatype corresponding to dtype</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">numpy_types</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">VEC_TYPES</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;cl.array.vec.make_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span></div>


<div class="viewcode-block" id="make_user_defined_dtype"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.make_user_defined_dtype">[docs]</a><span class="k">def</span> <span class="nf">make_user_defined_dtype</span><span class="p">(</span><span class="n">ctxs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">definition</span><span class="p">):</span>

    <span class="k">global</span> <span class="n">numpy_types</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">numpy_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">definition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">numpy_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Cant recognize definition {0} should be one of {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">numpy_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">numpy_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span> <span class="o">!=</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Conflicting definitions {0} and {1} for {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numpy_types</span><span class="p">[</span><span class="n">definition</span><span class="p">],</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                                         <span class="n">name</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">numpy_types</span><span class="p">[</span><span class="n">v</span><span class="p">]),</span> <span class="n">definition</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">struct</span><span class="p">,</span> <span class="n">c_decl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">match_dtype_to_c_struct</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected data type definition to be string or dict but got {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">)))</span></div>


<div class="viewcode-block" id="notify_callback"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.notify_callback">[docs]</a><span class="k">def</span> <span class="nf">notify_callback</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">dev_no</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">host_event_info</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">blank_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper function that generates and returns a call-back function based on parameters. This callback function is run whenever a enqueue operation finishes execution. User can suitably modify callback functions to carry out further processing run after completion of enqueue read buffers operation indicating completion of a kernel task.</span>

<span class="sd">    :param kernel: Kernel Object</span>
<span class="sd">    :type kernel:  pyschedcl.Kernel object</span>
<span class="sd">    :param device: Device Type (CPU or GPU)</span>
<span class="sd">    :type device: String</span>
<span class="sd">    :param dev_no: PySchedCL specific device id</span>
<span class="sd">    :type dev_no: Integer</span>
<span class="sd">    :param event_type: Event Type (Write, NDRange, Read)</span>
<span class="sd">    :type event_type: String</span>
<span class="sd">    :param events: List of Events associated with an Operation</span>
<span class="sd">    :type events: list of pyopencl.Event objects</span>
<span class="sd">    :param host_event_info: HostEvents object associated with Kernel</span>
<span class="sd">    :type host_event_info: HostEvents</span>
<span class="sd">    :param callback: Custom Callback function for carrying out further post processing if required.</span>
<span class="sd">    :type callback: python function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">bolt</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">callback_queue</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span>
            <span class="n">callback_queue</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">compare_and_swap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">debug_probe_string</span> <span class="o">=</span> <span class="s2">&quot;CALLBACK_PROBE : &quot;</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">event_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; event&quot;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">debug_probe_string</span><span class="p">)</span>
            <span class="n">debug_trigger_string</span> <span class="o">=</span> <span class="s2">&quot;CALLBACK_TRIGGERED : &quot;</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">event_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; execution finished for device &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">debug_trigger_string</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;WRITE&#39;</span><span class="p">:</span>
                <span class="n">host_event_info</span><span class="o">.</span><span class="n">write_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;READ&#39;</span><span class="p">:</span>
                <span class="n">host_event_info</span><span class="o">.</span><span class="n">read_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">global</span> <span class="n">device_history</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CALLBACK : &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">host_event_info</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CALLBACK : Pushing info onto &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dev_no</span><span class="p">))</span>
                <span class="n">device_history</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="n">dev_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host_event_info</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">kernel</span><span class="o">.</span><span class="n">multiple_break</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span>
                        <span class="n">kernel</span><span class="o">.</span><span class="n">chunks_cpu</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kernel</span><span class="o">.</span><span class="n">chunks_gpu</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span> <span class="ow">and</span> <span class="n">kernel</span><span class="o">.</span><span class="n">chunks_cpu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">kernel</span><span class="o">.</span><span class="n">release_buffers</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span> <span class="ow">and</span> <span class="n">kernel</span><span class="o">.</span><span class="n">chunks_gpu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">kernel</span><span class="o">.</span><span class="n">release_buffers</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">release_buffers</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">kernel</span><span class="o">.</span><span class="n">chunks_left</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">kernel</span><span class="o">.</span><span class="n">chunks_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">global</span> <span class="n">dump_output</span>
                    <span class="k">if</span> <span class="n">dump_output</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">pickle</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">SOURCE_DIR</span> <span class="o">+</span> <span class="s2">&quot;output/&quot;</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">partition</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span>
                        <span class="k">print</span> <span class="s2">&quot;Dumping Pickle&quot;</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">handle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s2">&quot;Dumped Pickle&quot;</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">release_host_arrays</span><span class="p">()</span>

                <span class="k">global</span> <span class="n">ready_queue</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">test_and_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="k">pass</span>
                <span class="n">ready_queue</span><span class="p">[</span><span class="n">device</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev_no</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span>
                    <span class="k">global</span> <span class="n">nGPU</span>
                    <span class="n">nGPU</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">global</span> <span class="n">nCPU</span>
                    <span class="n">nCPU</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">global</span> <span class="n">rqlock</span>
                <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;KERNEL&#39;</span><span class="p">:</span>
                <span class="n">host_event_info</span><span class="o">.</span><span class="n">ndrange_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">callback_queue</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">bolt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CALLBACK_RESET : &quot;</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; Resetting bolt value by &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">event_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; event&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">cb</span></div>


<div class="viewcode-block" id="generate_unique_id"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.generate_unique_id">[docs]</a><span class="k">def</span> <span class="nf">generate_unique_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates and returns a unique id string.</span>

<span class="sd">    :return: Unique ID</span>
<span class="sd">    :rtype: String</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">uuid</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span></div>


<div class="viewcode-block" id="Kernel"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel">[docs]</a><span class="k">class</span> <span class="nc">Kernel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to handle all operations performed on OpenCL kernel.</span>

<span class="sd">    :ivar dataset: An integer representing size of the data on which kernel will be dispatched.</span>
<span class="sd">    :ivar id: An id that is used identify a kernel uniquely.</span>
<span class="sd">    :ivar eco: A dictionary mapping between size of dataset and Estimated Computation Overhead</span>
<span class="sd">    :ivar name: Name of the Kernel</span>
<span class="sd">    :ivar src: Path to the Kernel source file.</span>
<span class="sd">    :ivar partition: An integer denoting the partition class of the kernel.</span>
<span class="sd">    :ivar work_dimension: Work Dimension of the Kernel.</span>
<span class="sd">    :ivar global_work_size: A list denoting global work dimensions along different axes.</span>
<span class="sd">    :ivar local_work_size: A list denoting local work dimensions along different axes.</span>
<span class="sd">    :ivar buffer_info: Properties of Buffers</span>
<span class="sd">    :ivar input_buffers: Dictionaries containing actual cl.Buf f er objects.</span>
<span class="sd">    :ivar output_buffers: Dictionaries containing actual cl.Buf f er objects.</span>
<span class="sd">    :ivar io_buffers: Dictionaries containing actual cl.Buf f er objects.</span>
<span class="sd">    :ivar data: Numpy Arrays maintaining the input and output data of the kernels.</span>
<span class="sd">    :ivar buffer_deps: Dictionary mapping containing buffer dependencies.</span>
<span class="sd">    :ivar variable_args: Data corresponding to Variable arguments of the kernel.</span>
<span class="sd">    :ivar local_args: Information regarding Local Arguments of the kernel.</span>
<span class="sd">    :ivar kernel objects: Dictionary mapping between devices and compiled and built pyopencl.Kernel objects.</span>
<span class="sd">    :ivar events: Dictionary containing pyschedcl.KEvents.</span>
<span class="sd">    :ivar source: String containing contents of kernel file.</span>
<span class="sd">    :ivar clevents: Dictionary containing pyopencl.Events.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise attributes of Kernel event.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">generate_unique_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">if</span> <span class="s1">&#39;ecos&#39;</span> <span class="ow">in</span> <span class="n">src</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">in</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;ecos&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eco</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;ecos&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="s1">&#39;eco&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eco</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;eco&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eco</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;partition&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">partition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">partition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_dimension</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;workDimension&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;globalWorkSize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;localWorkSize&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;localWorkSize&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;inputBuffers&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;inputBuffers&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;outputBuffers&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;outputBuffers&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;ioBuffers&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;ioBuffers&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;varArguments&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;varArguments&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vargs</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;varArguments&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vargs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;cpuArguments&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_args</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;cpuArguments&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;Ignoring CPU Arguments&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;gpuArguments&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_args</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;gpuArguments&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;Ignoring GPU Arguments&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;localArguments&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_args</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;localArguments&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># self.buffer_info[&#39;local&#39;] = deepcopy(self.local_args)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">btype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;io&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">])):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;chunk&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;chunk&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span>
                                                                                                           <span class="nb">unicode</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;chunk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;chunk&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;create&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="s1">&#39;from&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">][</span><span class="s1">&#39;kernel&#39;</span><span class="p">],</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partition_multiples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_partition_multiples</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># self.clevents = {&#39;gpu&#39;: dict(), &#39;cpu&#39;: dict()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_left</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple_break</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_cpu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_gpu</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Kernel.get_num_global_work_items"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_num_global_work_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_global_work_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total number of global work items based on global work size.</span>

<span class="sd">        :return: Total number of global work items considering all dimensions</span>
<span class="sd">        :rtype: Integer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">*=</span> <span class="n">j</span>
        <span class="k">return</span> <span class="n">i</span></div>

    <span class="c1"># TODO: Modify to handle dependent buffers.</span>

<div class="viewcode-block" id="Kernel.release_host_arrays"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.release_host_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">release_host_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forcefully releases all host array data after completion of a kernel task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">array_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">array_type</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">array</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Releasing host arrays&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>

<div class="viewcode-block" id="Kernel.release_buffers"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.release_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">release_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Releases all buffers of a Kernel Object for a particular device given in obj</span>

<span class="sd">        :param obj: Specifies Kernel object</span>
<span class="sd">        :type obj: String</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug_str</span> <span class="o">=</span> <span class="s2">&quot;Releasing buffers of &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; on &quot;</span> <span class="o">+</span> <span class="n">obj</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">debug_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">buff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">buff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">buff</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">buff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">buff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">buff</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">buff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">buff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">buff</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="Kernel.eval_vargs"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.eval_vargs">[docs]</a>    <span class="k">def</span> <span class="nf">eval_vargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">size_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exact</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to evaluate kernel arguments. Evaluates variable kernel arguments from the specification file if they are an expression against size percent.</span>

<span class="sd">        :param partition: Partition Class Value</span>
<span class="sd">        :type partition: Integer</span>
<span class="sd">        :param size_percent: Percentage of problem space to be processed on device</span>
<span class="sd">        :type size_percent: Integer</span>
<span class="sd">        :param offset_percent: Offset Percentage required</span>
<span class="sd">        :type offset_percent: Integer</span>
<span class="sd">        :param reverse: Flag for inverting size and offset calculations for respective devices</span>
<span class="sd">        :type reverse: Boolean</span>
<span class="sd">        :param exact: Flag that states whether percentage of problem space is greater than 50 or not (0 for percent &lt; 50, 1 for percent &gt;= 50)</span>
<span class="sd">        :param type: Integer</span>
<span class="sd">        :param total: Percentage of total problem space (Default value: 100)</span>
<span class="sd">        :type total: Integer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">partition_round</span><span class="p">(</span><span class="n">elms</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">part_round</span><span class="p">(</span><span class="n">elms</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">partition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="n">partition</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="n">offset_percent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">offset_percent</span> <span class="o">=</span> <span class="n">partition</span> <span class="o">*</span> <span class="mi">10</span>
                <span class="n">partition</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">partition</span>
                <span class="n">size_percent</span> <span class="o">=</span> <span class="n">partition</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vargs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vargs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vargs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Kernel.get_partition_multiples"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_partition_multiples">[docs]</a>    <span class="k">def</span> <span class="nf">get_partition_multiples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines partition multiples based on work dimension. This method returns a list of numbers based on global work size and local work size according to which the partition sizes will be determined.</span>

<span class="sd">        :return: List of integers representing partition multiples for each dimension</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">:</span>
                <span class="n">multiples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multiples</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">:</span>
                <span class="n">multiples</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multiples</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dimension</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">:</span>
                <span class="n">multiples</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Invalid Work Dimension&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">multiples</span></div>

<div class="viewcode-block" id="Kernel.build_kernel"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.build_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">build_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpus</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds Kernels from the directory kernel_src/ for each device and stores binaries in self.kernel_objects dict.</span>

<span class="sd">        :param gpus: List of OpenCL GPU Devices</span>
<span class="sd">        :type gpus: list of pyopencl.device objects</span>
<span class="sd">        :param cpus: List of OpenCL GPU Devices</span>
<span class="sd">        :type cpus: list of pyopencl.device objects</span>
<span class="sd">        :param ctxs: Dictionary of contexts keyed by device types</span>
<span class="sd">        :type ctxs: dict</span>
<span class="sd">        :return: Dictionary of key: value pairs where key is device type and value is the device specific binary compiled for the kernel</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">src_path</span> <span class="o">=</span> <span class="n">SOURCE_DIR</span> <span class="o">+</span> <span class="s1">&#39;kernel_src/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Kernel Source File </span><span class="si">%s</span><span class="s1"> not Found&#39;</span> <span class="o">%</span> <span class="n">src_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">src_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">programs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ctxs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ctxs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">programs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">programs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">gpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">programs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">cpus</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">programs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="n">programs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">programs</span></div>

<div class="viewcode-block" id="Kernel.random_data"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.random_data">[docs]</a>    <span class="k">def</span> <span class="nf">random_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="mi">4096</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates random data numpy arrays according to buffer type so that it can be enqueued to buffer. Can be used for testing. Will not generate random data for those buffers that are already enqueued. Creates empty arrays for read-only buffers. Populates values for self.data dictionary.</span>

<span class="sd">        :param low: Lower value of data array size</span>
<span class="sd">        :type low: Integer</span>
<span class="sd">        :param hi: Higher value of data array size</span>
<span class="sd">        :type hi: Integer</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
        <span class="n">integers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;uint&#39;</span><span class="p">,</span> <span class="s1">&#39;unsigned&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;unsigned int&#39;</span><span class="p">,</span> <span class="s1">&#39;long int&#39;</span><span class="p">,</span> <span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="s1">&#39;int2&#39;</span><span class="p">,</span> <span class="s1">&#39;int3&#39;</span><span class="p">,</span> <span class="s1">&#39;int4&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;int8&#39;</span><span class="p">,</span> <span class="s1">&#39;long16&#39;</span><span class="p">,</span> <span class="s1">&#39;long2&#39;</span><span class="p">,</span> <span class="s1">&#39;long3&#39;</span><span class="p">,</span> <span class="s1">&#39;long4&#39;</span><span class="p">,</span> <span class="s1">&#39;long8&#39;</span><span class="p">,</span> <span class="s1">&#39;short16&#39;</span><span class="p">,</span> <span class="s1">&#39;short2&#39;</span><span class="p">,</span> <span class="s1">&#39;short3&#39;</span><span class="p">,</span> <span class="s1">&#39;short4&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;short8&#39;</span><span class="p">,</span> <span class="s1">&#39;uint16&#39;</span><span class="p">,</span> <span class="s1">&#39;uint2&#39;</span><span class="p">,</span> <span class="s1">&#39;uint3&#39;</span><span class="p">,</span> <span class="s1">&#39;uint4&#39;</span><span class="p">,</span> <span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong16&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong2&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong3&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ulong4&#39;</span><span class="p">,</span> <span class="s1">&#39;ulong8&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort16&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort2&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort3&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort4&#39;</span><span class="p">,</span> <span class="s1">&#39;ushort8&#39;</span><span class="p">]</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;char16&#39;</span><span class="p">,</span> <span class="s1">&#39;char2&#39;</span><span class="p">,</span> <span class="s1">&#39;char3&#39;</span><span class="p">,</span> <span class="s1">&#39;char4&#39;</span><span class="p">,</span> <span class="s1">&#39;char8&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar16&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar2&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;uchar3&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar4&#39;</span><span class="p">,</span> <span class="s1">&#39;uchar8&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">btype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;io&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">btype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">])):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_write&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">btype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">integers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">btype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                            <span class="n">ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">btype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                            <span class="n">ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">btype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                        <span class="n">ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">btype</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]),</span>
                         <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Kernel.load_data"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates all host input arrays with given data.</span>

<span class="sd">        :param data: Dictionary structure comprising user defined data for host input arrays</span>
<span class="sd">        :type data: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]),</span>
                         <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Kernel.get_data"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the data of a particular kernel argument given its parameter position in the kernel.  Used to load dependent data.</span>

<span class="sd">        :param pos: Position of buffer argument in list of kernel arguments</span>
<span class="sd">        :type pos: Integer</span>
<span class="sd">        :return: Data stored in buffer specified by parameter position in kernel</span>
<span class="sd">        :rtype: Numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span></div>

<div class="viewcode-block" id="Kernel.get_buffer_info_location"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_buffer_info_location">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer_info_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns buffer_info location at given position. Used to make reusable buffers.</span>

<span class="sd">        :param pos: Position of buffer argument in list of kernel arguments</span>
<span class="sd">        :type pos: Integer</span>
<span class="sd">        :return: Tuple(key, i) where key represents type of buffer access and i represents the id for that buffer in self.buffer_info[key]</span>
<span class="sd">        :rtype: Tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span></div>

<div class="viewcode-block" id="Kernel.get_buffer_info"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_buffer_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns buffer information stored in Kernel specification file for buffer at given position in Kernel Arguments. Used to make reusable buffers.</span>

<span class="sd">        :param pos: Position of buffer argument in list of kernel arguments</span>
<span class="sd">        :type pos: Integer</span>
<span class="sd">        :return: Returns a dictionary of key:value pairs representing information of selected buffer in self.buffer_info</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buffer_info_location</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="Kernel.get_buffer"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns cl.Buffer objects given its parameter position in the kernel.</span>

<span class="sd">        :param pos: Position of buffer argument in list of kernel arguments</span>
<span class="sd">        :type: Integer</span>
<span class="sd">        :return: PyOpenCL Buffer Object for selected buffer</span>
<span class="sd">        :rtype: pyopencl.Buffer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">btype</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buffer_info_location</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">btype</span> <span class="ow">is</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">btype</span> <span class="ow">is</span> <span class="s1">&#39;io&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">btype</span> <span class="ow">is</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected buffer to be either input, io or output but got &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">btype</span><span class="p">))</span></div>

<div class="viewcode-block" id="Kernel.get_slice_values"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_slice_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns Element offset, size based on size_percent, offset_percent.</span>

<span class="sd">        :param buffer_info: Dictionary of key:value pairs representing information of one buffer</span>
<span class="sd">        :type buffer_info: dict</span>
<span class="sd">        :param size_percent: Size of buffer to be processed (in percentage)</span>
<span class="sd">        :type size_percent: Float</span>
<span class="sd">        :param offset_percent: Offset for given buffer (in percentage)</span>
<span class="sd">        :type offset_percent: Float</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :type kwargs:</span>
<span class="sd">        :return: Tuple representing element offset and number of elements</span>
<span class="sd">        :rtype: Tuple</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : </span><span class="si">%s</span><span class="s2"> get_slice_values -&gt; Original Buffer Size: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;chunk&#39;</span> <span class="ow">in</span> <span class="n">buffer_info</span><span class="p">:</span>
            <span class="n">partition_multiples</span> <span class="o">=</span> <span class="p">[</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;chunk&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_multiples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">partition_multiples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_multiples</span>

        <span class="k">if</span> <span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;break&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">eo</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;exact&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">eo</span> <span class="o">=</span> <span class="n">multiple_round</span><span class="p">(</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="n">partition_multiples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">multiple_round</span><span class="p">(</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">partition_multiples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eo</span> <span class="o">=</span> <span class="n">multiple_round</span><span class="p">(</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="n">partition_multiples</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">multiple_round</span><span class="p">(</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">partition_multiples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span></div>

<div class="viewcode-block" id="Kernel.create_buffers"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.create_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">create_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">size_percent</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates buffers for a Context while respecting partition information provided for every buffer associated with the kernel.</span>

<span class="sd">        :param ctx: PyOpenCL Context for either a CPU or a GPU device</span>
<span class="sd">        :type ctx: pyopencl.Context</span>
<span class="sd">        :param obj: Device Type</span>
<span class="sd">        :type obj: String</span>
<span class="sd">        :param size_percent: Size of valid buffer space for device</span>
<span class="sd">        :type size_percent: Float</span>
<span class="sd">        :param offset_percent: Offset parameter representing</span>
<span class="sd">        :type offset_percent:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :type kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Creating Input Buffers </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;create&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Create_Input_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Create_Input_Buffers_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span>
                                                       <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Creating Output Buffers </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;create&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Create_Output_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Create_Output_Buffers_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span>
                                                        <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Creating IO Buffers </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;create&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Create_IO_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Create_IO_Buffers_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span>
                                                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span></div>

<div class="viewcode-block" id="Kernel.set_kernel_args"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.set_kernel_args">[docs]</a>    <span class="k">def</span> <span class="nf">set_kernel_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets Kernel Arguments (Buffers and Variable Arguments).</span>

<span class="sd">        :param obj: Device Type (cpu or gpu)</span>
<span class="sd">        :type obj: String</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">)):</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                 <span class="n">make_ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])(</span>
                                                     <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                                 <span class="n">make_ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])(</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">variable_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                                             <span class="n">cl</span><span class="o">.</span><span class="n">LocalMemory</span><span class="p">(</span><span class="n">make_ctype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])()</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">local_args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])))</span></div>

<div class="viewcode-block" id="Kernel.enqueue_write_buffers"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.enqueue_write_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">enqueue_write_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">q_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">size_percent</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueues list of write buffer operations to the OpenCL Runtime.</span>

<span class="sd">        :param queue: Command Queue for a CPU or a GPU device</span>
<span class="sd">        :type queue: pyopencl.CommandQueue</span>
<span class="sd">        :param q_id: ID of queue</span>
<span class="sd">        :type q_id: Integer</span>
<span class="sd">        :param obj: Device Type (CPU or GPU)</span>
<span class="sd">        :type obj: String</span>
<span class="sd">        :param size_percent: Percentage of problem space to be processed</span>
<span class="sd">        :type size_percent: Integer</span>
<span class="sd">        :param offset_percent: Percentage for offset required for selection of host array space to be copied to buffer</span>
<span class="sd">        :type offset_percent: Integer</span>
<span class="sd">        :param deps: Initial PyOpenCL Event on which subsequent write operations will be dependent stored in a list</span>
<span class="sd">        :type deps: list of pyopencl.Event Objects</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :type kwargs:</span>
<span class="sd">        :return: Barrier Event signifying end of write operation</span>
<span class="sd">        :rtype: pyopencl.event</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">iev</span><span class="p">,</span> <span class="n">ioev</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]),</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">depends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Enqueuing Write Buffers </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;host_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start_barrier_event</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_barrier</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_write&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Write_Input_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Write_Input_Buffers_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                              <span class="n">ne</span><span class="p">)</span>
                <span class="n">iev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">],</span>
                                         <span class="n">is_blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]:</span>
            <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_write&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Write_IO_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Write_IO_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                <span class="n">ioev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">],</span>
                                          <span class="n">is_blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">iev</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ioev</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Number of write buffers </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iev</span><span class="p">)))</span>
        <span class="n">barrier_event</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_barrier</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">iev</span><span class="p">)</span>
        <span class="n">barrier_event</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">command_execution_status</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span>
                                   <span class="n">notify_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">q_id</span><span class="p">,</span> <span class="s1">&#39;WRITE&#39;</span><span class="p">,</span> <span class="n">iev</span><span class="p">,</span> <span class="n">host_event_info</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;host_event&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">barrier_event</span></div>

<div class="viewcode-block" id="Kernel.enqueue_nd_range_kernel"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.enqueue_nd_range_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">enqueue_nd_range_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">q_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">size_percent</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueues ND Range Kernel Operation for a kernel</span>

<span class="sd">        :param queue: OpenCL Command Queue</span>
<span class="sd">        :type queue: pyopencl.CommandQueue</span>
<span class="sd">        :param q_id: Framework specific id assigned to Command Queue</span>
<span class="sd">        :type q_id: Integer</span>
<span class="sd">        :param obj: OpenCL Device Type</span>
<span class="sd">        :type obj: String</span>
<span class="sd">        :param size_percent: Percentage of problem space to be processed</span>
<span class="sd">        :type size_percent: Integer</span>
<span class="sd">        :param offset_percent: Percentage for offset required for selection of host array space to be copied to buffer</span>
<span class="sd">        :type offset_percent: Integer</span>
<span class="sd">        :param deps:  PyOpenCL Event on which subsequent ndrange operations will be dependent on stored in a list</span>
<span class="sd">        :type deps: list of pyopencl.Event Objects</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :type kwargs:</span>
<span class="sd">        :return: Barrier Event signifying end of ndrange operation</span>
<span class="sd">        :rtype: pyopencl.event</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">global_work_offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">)</span>
        <span class="n">global_work_size</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_work_size</span><span class="p">)</span>
        <span class="n">global_work_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_round</span><span class="p">(</span><span class="n">global_work_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_multiples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># global_work_offset[0] = multiple_round(global_work_size[0], offset_percent,self.partition_multiples, **kwargs)</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">depends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;host_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndrange_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_nd_range_kernel</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">],</span> <span class="n">global_work_size</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">local_work_size</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_nd_range_kernel</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">],</span> <span class="n">global_work_size</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                            <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">barrier_event</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_barrier</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="p">[</span><span class="n">ev</span><span class="p">])</span>
        <span class="n">barrier_event</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">command_execution_status</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span>
                                   <span class="n">notify_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">q_id</span><span class="p">,</span> <span class="s1">&#39;KERNEL&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ev</span><span class="p">],</span>
                                                   <span class="n">host_event_info</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;host_event&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">barrier_event</span></div>

<div class="viewcode-block" id="Kernel.enqueue_read_buffers"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.enqueue_read_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">enqueue_read_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">q_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">size_percent</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">blank_fn</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue Read Buffer operations for a kernel.</span>

<span class="sd">        :param queue: OpenCL Command Queue</span>
<span class="sd">        :type queue: pyopencl.CommandQueue</span>
<span class="sd">        :param q_id: Framework specific id assigned to Command Queue</span>
<span class="sd">        :type q_id: Integer</span>
<span class="sd">        :param obj: OpenCL Device Type</span>
<span class="sd">        :type obj: String</span>
<span class="sd">        :param size_percent: Percentage of problem space to be processed</span>
<span class="sd">        :type size_percent: Integer</span>
<span class="sd">        :param offset_percent: Percentage for offset required for selection of host array space to be copied to buffer</span>
<span class="sd">        :type offset_percent: Integer</span>
<span class="sd">        :param deps:  PyOpenCL Event on which subsequent ndrange operations will be dependent on stored in a list</span>
<span class="sd">        :type deps: list of pyopencl.Event Objects</span>
<span class="sd">        :param callback: Custom callback function</span>
<span class="sd">        :type callback: python function</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :type kwargs:</span>
<span class="sd">        :return: Barrier Event signifying end of read operation</span>
<span class="sd">        :rtype: pyopencl.event</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">oev</span><span class="p">,</span> <span class="n">ioev</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]),</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Enqueuing Read Buffers </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">depends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;host_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_read&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Read_Output_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Read_Output_Buffers_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                              <span class="n">ne</span><span class="p">)</span>
                <span class="n">oev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                         <span class="n">is_blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;enq_read&#39;</span><span class="p">]:</span>
                <span class="n">eo</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Read_IO_Buffers_element_offset : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION_</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> Enqueue_Read_IO_Buffers_number_of_elements : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                <span class="n">ioev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">eo</span><span class="p">:</span><span class="n">eo</span> <span class="o">+</span> <span class="n">ne</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_buffers</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">is_blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">oev</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ioev</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARTITION : Number of read buffers </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oev</span><span class="p">)))</span>
        <span class="n">barrier_event</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_barrier</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="n">oev</span><span class="p">)</span>
        <span class="n">barrier_event</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">command_execution_status</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span>
                                   <span class="n">notify_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">q_id</span><span class="p">,</span> <span class="s1">&#39;READ&#39;</span><span class="p">,</span> <span class="n">oev</span><span class="p">,</span> <span class="n">host_event_info</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;host_event&#39;</span><span class="p">],</span>
                                                   <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">barrier_event</span></div>

<div class="viewcode-block" id="Kernel.dispatch"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">,</span> <span class="n">cmd_qs</span><span class="p">,</span> <span class="n">dep</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">blank_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dispatches Kernel with given partition class value (0,1,2,...,10). 0 is for complete CPU and 10 is for complete GPU.</span>

<span class="sd">        :param gpu: Denotes the index of gpu device in cmd_qs[&#39;gpu&#39;] list or is -1 if we don&#39;t want to use device of this type.</span>
<span class="sd">        :type gpu: Integer</span>
<span class="sd">        :param cpu: Denotes the index of cpu device in cmd_qs[&#39;cpu&#39;] list or is -1 if we don&#39;t want to use device of this type.</span>
<span class="sd">        :type cpu: Integer</span>
<span class="sd">        :param ctxs: Dictionary of Contexts for CPU and GPU devices.</span>
<span class="sd">        :type ctxs: dict</span>
<span class="sd">        :param cmd_qs: Dictionary of list of Command Queues</span>
<span class="sd">        :type cmd_qs: dict</span>
<span class="sd">        :param dep: PyOpenCL Event on which subsequent write operations will be dependent on stored in a list</span>
<span class="sd">        :param partition: Integer from 0 to 10 or None denoting partition class value.</span>
<span class="sd">        :type partition: Integer</span>
<span class="sd">        :param callback: A function that will run on the host side once the kernel completes execution on the device. Handle unexpected arguments.</span>
<span class="sd">        :return: Tuple with first element being the starting time (host side) of dispatch and second element being list of kernel events for both CPU and GPU devices</span>
<span class="sd">        :rtype: Tuple</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dispatch_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH : Dispatch function call for </span><span class="si">%s</span><span class="s2"> starts at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="p">)</span>

        <span class="n">gpu_host_events</span> <span class="o">=</span> <span class="n">HostEvents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="o">=</span><span class="n">dispatch_start</span><span class="p">)</span>
        <span class="n">cpu_host_events</span> <span class="o">=</span> <span class="n">HostEvents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="o">=</span><span class="n">dispatch_start</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">partition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span>
        <span class="k">if</span> <span class="n">dep</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">UserEvent</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">gpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">cpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="n">gpu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">cpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">cpu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">gpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="n">gdone</span><span class="p">,</span> <span class="n">cdone</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks_left</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">gpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dispatch_id</span> <span class="o">=</span> <span class="n">generate_unique_id</span><span class="p">()</span>

            <span class="k">while</span> <span class="n">test_and_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">global</span> <span class="n">nGPU</span>
            <span class="n">nGPU</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">offset_percent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Evaluation of kernel arguments for </span><span class="si">%s</span><span class="s2"> on GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_vargs</span><span class="p">(</span><span class="n">size_percent</span><span class="o">=</span><span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="n">offset_percent</span><span class="p">)</span>
            <span class="n">gpu_host_events</span><span class="o">.</span><span class="n">create_buf_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Creation of buffers for </span><span class="si">%s</span><span class="s2"> on GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_buffers</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">],</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">)</span>
            <span class="n">gpu_host_events</span><span class="o">.</span><span class="n">create_buf_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Setting kernel arguments for </span><span class="si">%s</span><span class="s2"> on GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_kernel_args</span><span class="p">(</span><span class="s1">&#39;gpu&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu :Calling enqueue_write_buffers for GPU&quot;</span><span class="p">)</span>
            <span class="n">gdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_write_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">],</span> <span class="n">gpu</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                                    <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">deps</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]],</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">gpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Calling enqueue_nd_range_kernel for GPU&quot;</span><span class="p">)</span>
            <span class="n">gdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_nd_range_kernel</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">],</span> <span class="n">gpu</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">gdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                             <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">gpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Calling enqueue_read_buffers for GPU&quot;</span><span class="p">)</span>
            <span class="n">gdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_read_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">],</span> <span class="n">gpu</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                                   <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">gdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span>
                                                   <span class="n">host_event</span><span class="o">=</span><span class="n">gpu_host_events</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">test_and_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">global</span> <span class="n">nCPU</span>
            <span class="n">nCPU</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dispatch_id</span> <span class="o">=</span> <span class="n">generate_unique_id</span><span class="p">()</span>
            <span class="n">offset_percent</span> <span class="o">=</span> <span class="n">size_percent</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">size_percent</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Evaluation of kernel arguments for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_vargs</span><span class="p">(</span><span class="n">size_percent</span><span class="o">=</span><span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="n">offset_percent</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Calling creating_buffers for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cpu_host_events</span><span class="o">.</span><span class="n">create_buf_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_buffers</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">],</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">)</span>
            <span class="n">cpu_host_events</span><span class="o">.</span><span class="n">create_buf_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Calling set_kernel_args for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_kernel_args</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Calling enqueue_write_buffers for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_write_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                                    <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">deps</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]],</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">cpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Evaluation of enqueue_nd_range_kernel for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_nd_range_kernel</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">cdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                             <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">cpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Evaluation of enqueue_read_buffers for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_read_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                                   <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">cdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span>
                                                   <span class="n">host_event</span><span class="o">=</span><span class="n">cpu_host_events</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">]:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">command_execution_status</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH : </span><span class="si">%s</span><span class="s2"> ke.dispatch_end </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH : Evaluation of kernel arguments for </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH : Number of events </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gdone</span> <span class="o">+</span> <span class="n">cdone</span><span class="p">)))</span>
        <span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">]</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">]</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">dispatch_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH : Dispatch function call for </span><span class="si">%s</span><span class="s2"> ends at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dispatch_end</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">gdone</span> <span class="o">+</span> <span class="n">cdone</span></div>

<div class="viewcode-block" id="Kernel.dispatch_multiple"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.dispatch_multiple">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpus</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">,</span> <span class="n">cmd_qs</span><span class="p">,</span> <span class="n">dep</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">blank_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dispatch Kernel across multiple devices  with given partition class value (0,1,2,...,10). 0 is for complete CPU and 10 is for complete GPU.</span>

<span class="sd">        :param gpus: A list of gpu device ids</span>
<span class="sd">        :type gpus: list</span>
<span class="sd">        :param cpus: A list of cpu device ids</span>
<span class="sd">        :type cpus: list</span>
<span class="sd">        :param ctxs: Dictionary of Contexts for CPU and GPU devices.</span>
<span class="sd">        :type ctxs: dict</span>
<span class="sd">        :param cmd_qs: Dictionary of list of Command Queues</span>
<span class="sd">        :type cmd_qs: dict</span>
<span class="sd">        :param dep: PyOpenCL Event on which subsequent write operations will be dependent on stored in a list</span>
<span class="sd">        :param partition: Integer from 0 to 10 or None denoting partition class value.</span>
<span class="sd">        :type partition: Integer</span>
<span class="sd">        :param callback: A function that will run on the host side once the kernel completes execution on the device. Handle unexpected arguments.</span>
<span class="sd">        :return: Tuple with first element being the starting time (host side) of dispatch and second element being list of kernel events for both CPU and GPU devices</span>
<span class="sd">        :rtype: Tuple</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dispatch_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH : Dispatch function call for </span><span class="si">%s</span><span class="s2"> starts at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">test_and_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">global</span> <span class="n">nGPU</span>
        <span class="n">nGPU</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">nCPU</span>
        <span class="n">nCPU</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span>
        <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple_break</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_cpu</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_gpu</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">partition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
        <span class="n">size_percent</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">total</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gpu_percent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gpu_percent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gpu_percent</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">gpu_percent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nGPU</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpu_percent</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">nCPU</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span>
        <span class="n">cpu_percent</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">gpu_percent</span>
        <span class="n">rqlock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gdone</span><span class="p">,</span> <span class="n">cdone</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">dep</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">deps</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">UserEvent</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">])</span>
            <span class="n">deps</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">UserEvent</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="n">gpu_percent</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)):</span>
            <span class="n">dispatch_id</span> <span class="o">=</span> <span class="n">generate_unique_id</span><span class="p">()</span>
            <span class="n">gpu_host_events</span> <span class="o">=</span> <span class="n">HostEvents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="o">=</span><span class="n">dispatch_start</span><span class="p">)</span>
            <span class="n">offset_percent</span> <span class="o">=</span> <span class="n">size_percent</span> <span class="o">*</span> <span class="n">i</span>
            <span class="n">exact</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">total</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">size_percent</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">offset_percent</span>
                <span class="n">exact</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="n">gpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Evaluation of kernel arguments for </span><span class="si">%s</span><span class="s2"> on GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_vargs</span><span class="p">(</span><span class="n">size_percent</span><span class="o">=</span><span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="n">offset_percent</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">)</span>
            <span class="n">gpu_host_events</span><span class="o">.</span><span class="n">create_buf_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : Calling creating_buffer for </span><span class="si">%s</span><span class="s2"> on GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_buffers</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">],</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">)</span>
            <span class="n">gpu_host_events</span><span class="o">.</span><span class="n">create_buf_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_kernel_args</span><span class="p">(</span><span class="s1">&#39;gpu&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : </span><span class="si">%s</span><span class="s2"> Calling enqueue_write_buffers for GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">gdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_write_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">],</span> <span class="n">gpu</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                                    <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">deps</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]],</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span>
                                                    <span class="n">host_event</span><span class="o">=</span><span class="n">gpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : </span><span class="si">%s</span><span class="s2"> Calling enqueue_nd_range_kernel for GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">gdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_nd_range_kernel</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">],</span> <span class="n">gpu</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">gdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                             <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span>
                                             <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">gpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_gpu : </span><span class="si">%s</span><span class="s2"> Calling enqueue_read_buffers for GPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">gdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_read_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">][</span><span class="n">gpu</span><span class="p">],</span> <span class="n">gpu</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                          <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">gdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span>
                                          <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">gpu_host_events</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size_percent</span> <span class="o">=</span> <span class="n">cpu_percent</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cpus</span><span class="p">)):</span>
            <span class="n">dispatch_id</span> <span class="o">=</span> <span class="n">generate_unique_id</span><span class="p">()</span>

            <span class="n">cpu_host_events</span> <span class="o">=</span> <span class="n">HostEvents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dispatch_start</span><span class="o">=</span><span class="n">dispatch_start</span><span class="p">)</span>
            <span class="n">exact</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">offset_percent</span> <span class="o">=</span> <span class="n">size_percent</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">gpu_percent</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">total</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">):</span>
                <span class="n">size_percent</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">offset_percent</span>
                <span class="n">exact</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cpu</span> <span class="o">=</span> <span class="n">cpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Evaluation of kernel arguments for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_vargs</span><span class="p">(</span><span class="n">size_percent</span><span class="o">=</span><span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="o">=</span><span class="n">offset_percent</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">)</span>
            <span class="n">cpu_host_events</span><span class="o">.</span><span class="n">create_buf_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Calling creating_buffer for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_buffers</span><span class="p">(</span><span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">],</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">)</span>
            <span class="n">cpu_host_events</span><span class="o">.</span><span class="n">create_buf_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_kernel_args</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Calling enqueue_write_buffers for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enqueue_write_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                                    <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">deps</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]],</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span>
                                                    <span class="n">host_event</span><span class="o">=</span><span class="n">cpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Evaluation of enqueue_nd_range_kernel for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_nd_range_kernel</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">cdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                             <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span>
                                             <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">cpu_host_events</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DISPATCH_cpu : Evaluation of enqueue_read_buffers for </span><span class="si">%s</span><span class="s2"> on CPU&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cdone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_read_buffers</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">][</span><span class="n">cpu</span><span class="p">],</span> <span class="n">cpu</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">size_percent</span><span class="p">,</span> <span class="n">offset_percent</span><span class="p">,</span>
                                          <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">cdone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">exact</span><span class="o">=</span><span class="n">exact</span><span class="p">,</span>
                                          <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">did</span><span class="o">=</span><span class="n">dispatch_id</span><span class="p">,</span> <span class="n">host_event</span><span class="o">=</span><span class="n">cpu_host_events</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">]:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">command_execution_status</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">gdone</span> <span class="o">+</span> <span class="n">cdone</span></div>

<div class="viewcode-block" id="Kernel.get_device_requirement"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.Kernel.get_device_requirement">[docs]</a>    <span class="k">def</span> <span class="nf">get_device_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">req</span></div></div>


<div class="viewcode-block" id="get_platform"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.get_platform">[docs]</a><span class="k">def</span> <span class="nf">get_platform</span><span class="p">(</span><span class="n">vendor_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets platform given a vendor name</span>

<span class="sd">    :param vendor_name: Name of OpenCL Vendor</span>
<span class="sd">    :type vendor_name: string</span>
<span class="sd">    :return: OpenCL platform related with vendor name</span>
<span class="sd">    :rtype: PyOpenCL platform object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">platforms</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">get_platforms</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">platforms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">get_platforms</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">vendor_name</span> <span class="ow">in</span> <span class="n">pt</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pt</span>
        <span class="k">print</span><span class="p">(</span><span class="n">vendor_name</span> <span class="o">+</span> <span class="s2">&quot; Platform not found.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No platform found.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_multiple_devices"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.get_multiple_devices">[docs]</a><span class="k">def</span> <span class="nf">get_multiple_devices</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">,</span> <span class="n">num_devs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get Multiple Devices given a platform and dev type.</span>

<span class="sd">    :param platform: OpenCL Platform pertaining to some vendor</span>
<span class="sd">    :type platform: pyopencl.platform object</span>
<span class="sd">    :param dev_type: Device Type (CPU or GPU)</span>
<span class="sd">    :type dev_type: pyopencl.device_type object</span>
<span class="sd">    :param num_devs: Number of Devices</span>
<span class="sd">    :type num_devs: Integer</span>
<span class="sd">    :return: List of OpenCL devices</span>
<span class="sd">    :rtype: list of pyopencl.device objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devs</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">dev_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_devs</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Requirement: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_devs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; greater than availability: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">devs</span><span class="p">[:</span><span class="n">num_devs</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_single_device"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.get_single_device">[docs]</a><span class="k">def</span> <span class="nf">get_single_device</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get Single Device given a platform and dev type.</span>

<span class="sd">    :param platform: OpenCL platform pertaining to some vendor</span>
<span class="sd">    :type platform: pyopencl.platform object</span>
<span class="sd">    :param dev_type: Device Type (CPU or GPU)</span>
<span class="sd">    :type dev_type: pyopencl.device_type object</span>
<span class="sd">    :return: List containing one OpenCL device</span>
<span class="sd">    :rtype: List containing one pyopencl.device object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_multiple_devices</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_sub_devices"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.get_sub_devices">[docs]</a><span class="k">def</span> <span class="nf">get_sub_devices</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">,</span> <span class="n">num_devs</span><span class="p">,</span> <span class="n">total_compute</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get Sub Devices given a platform and dev type.</span>

<span class="sd">    :param platform: OpenCL platform pertaining to some vendor</span>
<span class="sd">    :type platform: pyopencl.platform object</span>
<span class="sd">    :param dev_type: Device Type (CPU or GPU)</span>
<span class="sd">    :type dev_type: pyopencl.device_type object</span>
<span class="sd">    :param num_devs: Number of devices</span>
<span class="sd">    :type num_devs: Integer</span>
<span class="sd">    :param total_compute: Total Number of Compute Units for an OpenCL device</span>
<span class="sd">    :type total_compute: Integer</span>
<span class="sd">    :return: List of OpenCL subdevices for a particular device</span>
<span class="sd">    :rtype: list of pyopencl.device objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">get_single_device</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dev</span><span class="o">.</span><span class="n">create_sub_devices</span><span class="p">([</span><span class="n">cl</span><span class="o">.</span><span class="n">device_partition_property</span><span class="o">.</span><span class="n">EQUALLY</span><span class="p">,</span> <span class="n">total_compute</span> <span class="o">/</span> <span class="n">num_devs</span><span class="p">])</span></div>


<div class="viewcode-block" id="create_command_queue_for_each"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.create_command_queue_for_each">[docs]</a><span class="k">def</span> <span class="nf">create_command_queue_for_each</span><span class="p">(</span><span class="n">devs</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates command queue for a specified number of devices belonging to a context provided as argument</span>

<span class="sd">    :param devs: List of OpenCL devices</span>
<span class="sd">    :type devs: List of pyopencl.device objects</span>
<span class="sd">    :param ctx: OpenCL Context</span>
<span class="sd">    :rtype ctx: pyopencl.context object</span>
<span class="sd">    :return: List of OpenCL Command Queues</span>
<span class="sd">    :rtype: list of pyopencl.CommandQueue objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_qs</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">dev</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">cl</span><span class="o">.</span><span class="n">command_queue_properties</span><span class="o">.</span><span class="n">PROFILING_ENABLE</span><span class="p">)</span> <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">devs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cmd_qs</span></div>


<div class="viewcode-block" id="host_initialize"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.host_initialize">[docs]</a><span class="k">def</span> <span class="nf">host_initialize</span><span class="p">(</span><span class="n">num_gpus</span><span class="o">=</span><span class="n">cons</span><span class="o">.</span><span class="n">NUM_GPU_DEVICES</span><span class="p">,</span> <span class="n">num_cpus</span><span class="o">=</span><span class="n">cons</span><span class="o">.</span><span class="n">NUM_CPU_DEVICES</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">cpu_platform</span><span class="o">=</span><span class="n">cons</span><span class="o">.</span><span class="n">CPU_PLATFORM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gpu_platform</span><span class="o">=</span><span class="n">cons</span><span class="o">.</span><span class="n">GPU_PLATFORM</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set local=True if your device doesn&#39;t support GPU. But you still</span>
<span class="sd">    want to pretend as if you have one.</span>

<span class="sd">    :param num_gpus: Number of GPU Devices</span>
<span class="sd">    :type num_gpus: Integer</span>
<span class="sd">    :param num_cpus: Number of CPU Devices</span>
<span class="sd">    :type num_cpus: Integer</span>
<span class="sd">    :param local: Flag for Specifying whether platform supports GPU or not</span>
<span class="sd">    :type local: Boolean</span>
<span class="sd">    :param cpu_platform: CPU Platform Name</span>
<span class="sd">    :type cpu_platform: String</span>
<span class="sd">    :param gpu_platform: GPU Platform Name</span>
<span class="sd">    :type gpu_platform: String</span>
<span class="sd">    :return: Returns a tuple comprising command queue dictionary, context dictionary and list of OpenCL CPU and GPU devices.</span>
<span class="sd">    :rtype: Tuple</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">nGPU</span>
    <span class="k">global</span> <span class="n">nCPU</span>
    <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cpu_platform</span> <span class="o">=</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">cpu_platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_cpus</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">get_cl_header_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="n">get_sub_devices</span><span class="p">(</span><span class="n">cpu_platform</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">CPU</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="n">get_single_device</span><span class="p">(</span><span class="n">cpu_platform</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">cpus</span><span class="p">)</span>
        <span class="n">ctxs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">}</span>
        <span class="n">cmd_q</span> <span class="o">=</span> <span class="n">create_command_queue_for_each</span><span class="p">(</span><span class="n">cpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">])</span>
        <span class="c1"># cmd_qs = {&quot;gpu&quot;:cmd_q, &quot;cpu&quot;: cmd_q}</span>
        <span class="n">cmd_qs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cmd_q</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cmd_q</span><span class="p">[</span><span class="mi">1</span><span class="p">]]}</span>
        <span class="n">ready_queue</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ready_queue</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">device_history</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">device_history</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">cpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpus</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">nGPU</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nCPU</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">gpus</span><span class="p">,</span> <span class="n">cpus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">ctxs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="n">cmd_qs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">num_gpus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gpu_platform</span> <span class="o">=</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">gpu_platform</span><span class="p">)</span>
            <span class="n">gpus</span> <span class="o">=</span> <span class="n">get_multiple_devices</span><span class="p">(</span><span class="n">gpu_platform</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">GPU</span><span class="p">,</span> <span class="n">num_gpus</span><span class="p">)</span>
            <span class="c1"># print gpus</span>
            <span class="k">global</span> <span class="n">MAX_GPU_ALLOC_SIZE</span>
            <span class="n">MAX_GPU_ALLOC_SIZE</span> <span class="o">=</span> <span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max_mem_alloc_size</span>
            <span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">gpus</span><span class="p">)</span>
            <span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_command_queue_for_each</span><span class="p">(</span><span class="n">gpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">num_cpus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># cpu_platform = get_platform(&quot;AMD Accelerated Parallel Processing&quot;)</span>
            <span class="n">cpu_platform</span> <span class="o">=</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">cpu_platform</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_cpus</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cl</span><span class="o">.</span><span class="n">get_cl_header_version</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">cpus</span> <span class="o">=</span> <span class="n">get_sub_devices</span><span class="p">(</span><span class="n">cpu_platform</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">CPU</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cpus</span> <span class="o">=</span> <span class="n">get_single_device</span><span class="p">(</span><span class="n">cpu_platform</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
            <span class="c1"># print cpus</span>
            <span class="k">global</span> <span class="n">MAX_CPU_ALLOC_SIZE</span>
            <span class="n">MAX_CPU_ALLOC_SIZE</span> <span class="o">=</span> <span class="n">cpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max_mem_alloc_size</span>
            <span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">cpus</span><span class="p">)</span>
            <span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_command_queue_for_each</span><span class="p">(</span><span class="n">cpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">])</span>
        <span class="n">nGPU</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">])</span>
        <span class="n">nCPU</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmd_qs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ready_queue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
            <span class="n">device_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">[</span><span class="n">key</span><span class="p">]))])</span>
    <span class="k">global</span> <span class="n">system_cpus</span>
    <span class="k">global</span> <span class="n">system_gpus</span>
    <span class="n">system_cpus</span> <span class="o">=</span> <span class="n">nCPU</span>
    <span class="n">system_gpus</span> <span class="o">=</span> <span class="n">nGPU</span>
    <span class="k">return</span> <span class="n">cmd_qs</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">,</span> <span class="n">gpus</span><span class="p">,</span> <span class="n">cpus</span></div>


<div class="viewcode-block" id="host_synchronize"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.host_synchronize">[docs]</a><span class="k">def</span> <span class="nf">host_synchronize</span><span class="p">(</span><span class="n">cmd_qs</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures that all operations in all command queues and associated events have finished execution</span>

<span class="sd">    :param cmd_qs: Dictionary of list of Command Queues</span>
<span class="sd">    :type cmd_qs: dict</span>
<span class="sd">    :param events: List of OpenCL Events</span>
<span class="sd">    :type events: list of pyopencl.events</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">nCPU</span><span class="p">,</span> <span class="n">nGPU</span><span class="p">,</span> <span class="n">system_cpus</span><span class="p">,</span> <span class="n">system_gpus</span>
    <span class="k">while</span> <span class="n">nCPU</span> <span class="o">&lt;</span> <span class="n">system_cpus</span> <span class="ow">or</span> <span class="n">nGPU</span> <span class="o">&lt;</span> <span class="n">system_gpus</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">global</span> <span class="n">callback_queue</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">callback_queue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">callback_queue</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">pass</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmd_qs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">cmd_qs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span></div>


<div class="viewcode-block" id="build_kernel_from_info"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.build_kernel_from_info">[docs]</a><span class="k">def</span> <span class="nf">build_kernel_from_info</span><span class="p">(</span><span class="n">info_file_name</span><span class="p">,</span> <span class="n">gpus</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Kernel object from info.</span>

<span class="sd">    :param info_file_name: Name of OpenCL Kernel Specification File (JSON)</span>
<span class="sd">    :type info_file_name: String</span>
<span class="sd">    :param gpus: List of OpenCL GPU devices</span>
<span class="sd">    :type gpus: list of pyopencl.device objects</span>
<span class="sd">    :param cpus: List of OpenCL CPU devices</span>
<span class="sd">    :type cpus: list of pyopencl.device objects</span>
<span class="sd">    :param ctxs: Dictionary of contexts keyed by device types</span>
<span class="sd">    :type ctxs: dict</span>
<span class="sd">    :return: Dictionary of key: value pairs where key is device type and value is the device specific binary compiled for the kernel</span>
<span class="sd">    :rtype: dict</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">info_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">Kernel</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="n">ki</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(</span><span class="n">gpus</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">ctxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ki</span></div>


<span class="n">ALL_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rgb(31, 119, 180)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255, 127, 14)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(44, 160, 44)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(214, 39, 40)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(148, 103, 189)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(140, 86, 75)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(227, 119, 194)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(127, 127, 127)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(188, 189, 34)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(23, 190, 207)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(217,217,217)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(240,2,127)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(253,205,172)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(179,205,227)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(166,86,40)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(51,160,44)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(247,129,191)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(253,191,111)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(190,186,218)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(231,41,138)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(166,216,84)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(153,153,153)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(166,118,29)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(230,245,201)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255,255,204)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(102,102,102)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(77,175,74)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(228,26,28)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(217,95,2)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255,255,179)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(178,223,138)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(190,174,212)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(253,180,98)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255,217,47)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(31,120,180)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(56,108,176)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(229,216,189)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(251,154,153)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(222,203,228)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(203,213,232)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(188,128,189)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(55,126,184)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(231,138,195)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(244,202,228)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(191,91,23)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(128,177,211)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(27,158,119)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(229,196,148)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(253,218,236)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(102,166,30)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(241,226,204)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255,127,0)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(252,141,98)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(227,26,28)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(254,217,166)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(141,160,203)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(204,235,197)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(117,112,179)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(152,78,163)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(202,178,214)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(141,211,199)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(106,61,154)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(253,192,134)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255,255,51)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(179,226,205)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(127,201,127)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(251,128,114)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(255,242,174)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(230,171,2)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(102,194,165)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(255,255,153)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(179,179,179)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(179,222,105)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(252,205,229)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(204,204,204)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;rgb(242,242,242)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(166,206,227)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(251,180,174)&#39;</span><span class="p">]</span>

<span class="n">AC</span> <span class="o">=</span> <span class="n">ALL_COLORS</span>


<div class="viewcode-block" id="plot_gantt_chart_graph"><a class="viewcode-back" href="../../pyschedcl.html#pyschedcl.pyschedcl.plot_gantt_chart_graph">[docs]</a><span class="k">def</span> <span class="nf">plot_gantt_chart_graph</span><span class="p">(</span><span class="n">device_history</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots Gantt Chart and Saves as png.</span>

<span class="sd">    :param device_history: Dictionary Structure containing timestamps of every kernel on every device</span>
<span class="sd">    :type device_history: dict</span>
<span class="sd">    :param filename: Name of file where the gantt chart is saved. The plot is saved in gantt_charts folder.</span>
<span class="sd">    :type filename: String</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">colorsys</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="kn">as</span> <span class="nn">patches</span>

    <span class="k">def</span> <span class="nf">save_png</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;GANTT chart is saved at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">get_N_HexCol</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

        <span class="n">HSV_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">N</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
        <span class="n">hex_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rgb</span> <span class="ow">in</span> <span class="n">HSV_tuples</span><span class="p">:</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="o">*</span><span class="n">rgb</span><span class="p">))</span>
            <span class="n">hex_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="n">rgb</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">hex_out</span>

    <span class="k">def</span> <span class="nf">get_N_random_HexColor</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">HSV_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">N</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
        <span class="n">hex_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="s1">&#39;rgb(31, 119, 180)&#39;</span>
        <span class="n">indexs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">77</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indexs</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ALL_COLORS</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">g</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ALL_COLORS</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ALL_COLORS</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">hex_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hex_out</span>

    <span class="k">def</span> <span class="nf">list_from_file</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
        <span class="n">device_info_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dev_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dev_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;HOST_EVENT&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">d_list</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">device_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">device_info_list</span>

    <span class="k">def</span> <span class="nf">list_from_dev_history</span><span class="p">(</span><span class="n">dev_history</span><span class="p">):</span>
        <span class="n">device_info_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">his</span> <span class="ow">in</span> <span class="n">dev_history</span><span class="p">:</span>
            <span class="n">device_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">his</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">device_info_list</span>

    <span class="k">def</span> <span class="nf">get_min</span><span class="p">(</span><span class="n">device_info_list</span><span class="p">):</span>
        <span class="n">g_min</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;Infinity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">device_info_list</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">g_min</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">g_min</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">g_min</span>

    <span class="k">def</span> <span class="nf">get_max</span><span class="p">(</span><span class="n">device_info_list</span><span class="p">):</span>
        <span class="n">g_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">device_info_list</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">g_max</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">g_max</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">g_max</span>

    <span class="k">def</span> <span class="nf">normalise_timestamp</span><span class="p">(</span><span class="n">device_info_list</span><span class="p">):</span>
        <span class="n">min_t</span> <span class="o">=</span> <span class="n">get_min</span><span class="p">(</span><span class="n">device_info_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">device_info_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">item</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">min_t</span>
        <span class="k">return</span> <span class="n">device_info_list</span>

    <span class="n">device_info_list</span> <span class="o">=</span> <span class="n">normalise_timestamp</span><span class="p">(</span><span class="n">list_from_dev_history</span><span class="p">(</span><span class="n">device_history</span><span class="p">))</span>

    <span class="n">colourMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># colors = get_N_HexCol(len(device_info_list))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">get_N_random_HexColor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">device_info_list</span><span class="p">))</span>

    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dev_time</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">device_info_list</span><span class="p">:</span>
        <span class="n">kn</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">kernel_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">kn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dev_time</span><span class="p">:</span>
            <span class="n">dev_time</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kn</span> <span class="ow">in</span> <span class="n">dev_time</span><span class="p">:</span>
            <span class="n">dev_time</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernel_times</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">device_info_list</span><span class="p">:</span>
        <span class="n">colourMap</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># legend_patches = []</span>
    <span class="c1"># for kn in colourMap:</span>
    <span class="c1">#     patch_color = &quot;#&quot; + colourMap[kn]</span>
    <span class="c1">#     legend_patches.append(patches.Patch(color=patch_color, label=str(k[2])))</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#print dev_time</span>
    <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">dev_time</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dev_time</span><span class="p">[</span><span class="n">dev</span><span class="p">]:</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># patch_color = &quot;#&quot; + colourMap[kname]</span>
            <span class="n">patch_color</span> <span class="o">=</span> <span class="n">colourMap</span><span class="p">[</span><span class="n">kname</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">finish</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">device</span> <span class="o">*</span> <span class="mi">5</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">height</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">finish</span> <span class="o">-</span> <span class="n">start</span>
            <span class="c1"># print kname.split(&quot;,&quot;)[-1] + &quot; : &quot; + str(x) + &quot;,&quot; + str(y) + &quot;,&quot; + str(width) + &quot;,&quot; + str(height)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">patch_color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span>
                                           <span class="n">label</span><span class="o">=</span><span class="n">kname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">x_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_max</span><span class="p">(</span><span class="n">device_info_list</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">x_length</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dev_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
    <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">dev_time</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">y_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dev_time</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">y_ticks</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time ( in second )&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">save_png</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>


  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Anirban Ghose, Lokesh Dokara, Srijeeta Maity.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>





    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>





    <script type="text/javascript" src="../../_static/js/theme.js"></script>




  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>


</body>
</html>
